<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Configuration</title>
    <script src="/js/jquery.js"></script>
    <script src="/js/underscore.js"></script>
    <script src="/js/backbone.js"></script>
    <script src="/js/epoxy.js"></script>

    <link rel="stylesheet" href="/css/bootstrap.css" />

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>


    <link rel="stylesheet" href="/css/dashboard.css" />
</head>
<body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Inbox Watcher</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="/configs/ui">Settings</a></li>
                    <li><a href="/documentation">Help</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">

        <div class="row">
            <div class="col-md-12">
                <h2>Inbox Watcher Configuration</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-8">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Current Mail Box Configurations:
                    </div>
                    <div class="panel-body">
                        <div id="allConfigs">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Mail Box Name</th>
                                        <th>Host Name</th>
                                        <th>Port</th>
                                        <th>User Name</th>
                                        <th>Password</th>
                                        <th>Secure</th>
                                    </tr>
                                </thead>
                                <tbody id="mailboxtable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Selected Mail Box Notifications:
                    </div>
                    <div class="panel-body">
                        <table class="table table-striped table-hover" id="notificationsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Notification Type</th>
                                    <th>Mail Box ID</th>
                                </tr>
                            </thead>
                            <tbody id="notificationsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Add/Edit a Mail Box:
                    </div>
                    <div class="panel-body">
                        <div class="form-horizontal" id="newMailBoxForm">
                            <input type="hidden" name="id" id="mailBoxId" data-bind="value:Id" />
                            <div class="form-group">
                                <div class="col-md-12">
                                    <label for="inputMailBoxName">Mail Box Name: </label>
                                    <input type="text" name="mailboxname" id="inputMailBoxName" class="form-control" data-bind="value:MailBoxName" />
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-6">
                                    <label for="hostName">Host Name: </label>
                                    <input type="text" name="hostname" id="hostName" class="form-control" data-bind="value:HostName" />
                                </div>
                                <div class="col-md-3">
                                    <label for="port">Port: </label>
                                    <input type="number" name="port" id="port" class="form-control" data-bind="value:Port" />
                                </div>
                                <div class="col-md-3">
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" id="useSecure" name="UseSecure" data-bind="checked:UseSecure" /> Use Secure?
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-6">
                                    <label for="userName">User Name: </label>
                                    <input type="text" name="username" id="userName" class="form-control" data-bind="value:UserName" />
                                </div>
                                <div class="col-md-6">
                                    <label for="password">Password: </label>
                                    <input type="text" name="password" id="password" class="form-control" data-bind="value:Password" />
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-success newBtn">Create as new MailBox</button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-primary subBtn">Save changes to MailBox</button>
                                </div>
                                <div class="col-md-3">
                                    <button type="button" class="btn btn-danger delBtn">Delete MailBox</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Add/Edit Mail Box Notification:
                    </div>
                    <div class="panel-body">
                        <div class="form">
                            <div class="form-group">
                                <select class="form-control" id="notificationTypeSelect"></select>
                            </div>
                            <div id="notificationFormArea">

                            </div>
                            <div class="form-group">
                                <button class="btn btn-danger" id="notificationDelete">Delete Notification</button>
                                <button class="btn btn-info" id="notificationTest">Test Notification</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/template" id="config-item-templ">
</script>
<script>

    var SELECTEDMAILBOX = -1;

    var ConfigModel = Backbone.Model.extend({
        idAttribute: 'Id',
        defaults: {
            Id: null,
            UserName: null,
            Password: null,
            HostName: null,
            Port: null,
            UseSecure: null,
            MailBoxName: null
        }

    });

    var NotificationModel = Backbone.Model.extend({
        idAttribute: 'Id',
        defaults: {
            Id: null,
            ConfigurationXml: null,
            ImapMailBoxConfigurationId: null,
            NotificationType: null
        }
    });

    var ConfigsCollection = Backbone.Collection.extend({
        url: '/configs',
        model: ConfigModel
    });

    var ConfigsTableView = Backbone.View.extend({
        el: '#mailboxtable',

        initialize: function() {
            this.listenTo(this.collection, 'sync change', this.render);
            this.collection.fetch();
            this.render();
        },

        events: {
            'click .rw': 'onClickRow'
        },

        onClickRow: function (evt) {
            evt.preventDefault();

            var id = $(evt.currentTarget).data("id");

            SELECTEDMAILBOX = id;

            PopulateNotifiationsTable(id);

            var item = this.collection.get(id);

            item.url = '/configs/' + id;

            console.log("clicked item with id: " + id);


            mbView.onRemove();

            mbView = new MailBoxBindView({ model: item });

        },

        render: function() {
            var html = '';
            this.collection.each(function(m) {
                html += '<tr class="rw" data-id="' + m.get('Id') + '">';
                html += '<td>' + m.get('Id') + '</td>';
                html += '<td>' + m.get('MailBoxName') + '</td>';
                html += '<td>' + m.get('HostName') + '</td>';
                html += '<td>' + m.get('Port') + '</td>';
                html += '<td>' + m.get('UserName') + '</td>';
                html += '<td>' + m.get('Password') + '</td>';
                html += '<td>' + m.get('UseSecure') + '</td>';
                html += '</tr>';
            });
            this.$el.html(html);
            return this;
        }
    });

    var configs = new ConfigsCollection();
    var ConfigsTable = new ConfigsTableView({ collection: configs });

    var NotificationBindView = Backbone.Epoxy.View.extend({
        el: '#notificationTypeSelect',
        bindings: 'data-bind'
    });

    var MailBoxBindView = Backbone.Epoxy.View.extend({
        el: "#newMailBoxForm",
        bindings: "data-bind",
        events: {
            'click .subBtn': 'onClickSubmit',
            'click .delBtn': 'onClickDelete',
            'click .newBtn': 'onClickCreate'
        },

        initialize: function () {
            this.listenTo(this.model, 'sync change', this.render);
            this.model.fetch();
            this.render();
        },

        onClickSubmit: function(e) {
            e.preventDefault();
            this.model.save().then(function () { configs.fetch(); });

            this.onRemove();
        },

        onClickDelete: function(e) {
            e.preventDefault();

            this.model.destroy();

            setTimeout(function () { configs.fetch() }, 500);

            this.onRemove();
        },

        onClickCreate: function(e) {
            e.preventDefault();

            var newModel = this.model.toJSON();
            delete newModel.id;
            delete newModel.Id;

            console.log(newModel);

            configs.create(newModel);
            setTimeout(function () { configs.fetch() }, 500);

            this.onRemove();
        },

        onRemove: function() {
            this.undelegateEvents();
            this.unbind();
            this.removeBindings();
        }

    });

    var mbStartModel = new ConfigModel();
    mbStartModel.url = 'configs/0';

    var mbView = new MailBoxBindView({model: mbStartModel});


    $(document).ready(function() {
        //show registered notification types in add new select
        $.getJSON("/notifications/types", function (data) {
            var items = [];
            for (var i = 0; i < data.length; i++) {
                items.push("<option value='" + data[i] + "'>" + data[i] + "</option>");
            }
            $("#notificationTypeSelect").html(items.join(''));
            var selection = $("#notificationTypeSelect").val();
            NewNotification(selection);
        });

        $("#notificationTypeSelect").change(function () {
            var selection = $("#notificationTypeSelect").val();
            NewNotification(selection);
        });

        $("#notificationsTable").on('click', 'tr', function(e) {
            $("#notificationDelete").off();
            $("#notificationTest").off();
            var notType = $('td', this)[1];

            $("#notificationTypeSelect").val($(notType).text());
            $("#notificationsTable tr").removeClass('info');
            $(this).addClass('info');
            e.preventDefault();
            var id = $(this).attr('value');
            $("#notificationDelete").click(function() {
                $.ajax({
                    type: "DELETE",
                    url: "/notifications/" + id,
                    success: function(result) {
                        location.reload();
                    }
                });
            });

            $("#notificationTest").click(function() {
                $.ajax({
                    type: "POST",
                    url: "/config/notifications/id/test/" + id,
                    Accept: "application/json",
                    success: function (result) {
                        console.log(result);
                        alert("Tested and got result: " + result);
                    }
                });
            });
            $.getScript("/notifications/" + id, function() {
                $('#notificationFormArea').html('');
                SetupNotificationConfig();
                $("#editNotificationId").val(id);
                SetupNotificationListen();
            });
        });
    });


    function NewNotification(selection) {
        $.getScript("/notifications/data/" + selection, function () {
            $('#notificationFormArea').html('');
            SetupNotificationConfig();
            SetupNotificationListen();
        });
    }

    function SetupNotificationListen() {
        $("#notificationFormArea .btn").click(function () {
            var formData = $("#notificationFormArea :input");
            var postData = {};
            for (var i = 0; i < formData.length; i++) {
                postData[formData[i].name] = formData[i].value;
            }
            postData.Type = $("#notificationTypeSelect").val();
            postData.MailBoxId = SELECTEDMAILBOX;

            var httpMethod = "POST";

            //http put
            if ($("#editNotificationId").val() === -1) httpMethod = "PUT";

            $.ajax({
                type: httpMethod,
                url: "/notifications",
                contentType: "application/json",
                data: JSON.stringify(postData),
                success: function (d) {
                    console.log(d);
                    setTimeout(location.reload(), 1000);
                }
            });
        });
    }

    function PopulateNotifiationsTable(id) {
        $.getJSON("/notifications/" , function (data) {
            var items = [];
            for (var i = 0; i < data.length; i++) {
                if (data[i].ImapMailBoxConfigurationId !== id) continue;
                items.push("<tr value='" + data[i].Id + "'>");
                items.push("<td>" + data[i].Id + "</td>");
                items.push("<td>" + data[i].NotificationType + "</td>");
                items.push("<td>" + data[i].ImapMailBoxConfigurationId + "</td>");
                items.push("</tr>");
            }
            $("#notificationsTableBody").html(items.join(''));
        });
    }
</script>